<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | AnimeClips</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <script>
        tailwind.config = {
            theme: { extend: { colors: { gray: { 900: '#0f172a', 950: '#020617' } } } }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; }
        .material-symbols-rounded { font-size: 20px; }
        /* Smooth fade for number changes */
        .fade-num { transition: opacity 0.2s ease-in-out; }
        .fade-out { opacity: 0; }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-gradient-to-b from-gray-950 to-slate-950">

    <!-- ==== NAVBAR ==== -->
    <nav class="sticky top-0 z-50 border-b border-white/5 bg-slate-950/80 backdrop-blur-md">
        <div class="container mx-auto px-6 h-16 flex justify-between items-center">
            <div class="flex items-center gap-2 font-bold text-lg">
                <div class="w-7 h-7 bg-blue-600 rounded flex items-center justify-center text-white">
                    <span class="material-symbols-rounded" style="font-size: 18px;">admin_panel_settings</span>
                </div>
                <span class="text-slate-200">AnimeClips <span class="text-slate-600 font-normal text-sm ml-1">| Panel</span></span>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="logout()" class="bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500 hover:text-white px-3 py-1.5 rounded text-xs font-bold uppercase tracking-wide transition-all">
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- ==== MAIN CONTENT ==== -->
    <main class="container mx-auto px-6 py-8 flex-grow">
        
        <!-- 1. ANALYTICS CARDS -->
        <h2 class="text-white font-bold text-sm uppercase tracking-wider mb-4 flex items-center gap-2">
            <span class="material-symbols-rounded text-blue-500">monitoring</span> Analytics
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            
            <!-- CARD 1: LIBRARY SIZE (Static) -->
            <div class="bg-slate-900 border border-white/5 p-6 rounded-xl shadow-lg relative">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-2 bg-blue-500/10 text-blue-400 rounded-lg"><span class="material-symbols-rounded">video_library</span></div>
                </div>
                <div class="flex items-baseline gap-2">
                    <span class="text-4xl font-black text-white" id="stat-series">--</span>
                    <span class="text-sm text-slate-500 font-bold uppercase tracking-wider">Series</span>
                </div>
                <div class="text-xs text-slate-600 mt-2">Total active items in library</div>
            </div>

            <!-- CARD 2: DOWNLOADS (Dynamic) -->
            <div class="bg-slate-900 border border-white/5 p-6 rounded-xl shadow-lg relative group" id="card-dl">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-2 bg-emerald-500/10 text-emerald-400 rounded-lg"><span class="material-symbols-rounded">download</span></div>
                    
                    <!-- Dropdown Trigger -->
                    <div class="relative">
                        <button onclick="toggleDropdown('menu-dl')" class="text-slate-500 hover:text-white p-1 rounded hover:bg-slate-800 transition-colors">
                            <span class="material-symbols-rounded">more_vert</span>
                        </button>
                        <!-- Dropdown Menu -->
                        <div id="menu-dl" class="hidden absolute right-0 mt-2 w-32 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-20 py-1 text-xs font-bold text-slate-400 uppercase tracking-wider origin-top-right">
                            <button onclick="setMetric('dl', 'day', 'Today')" class="block w-full text-left px-4 py-2 hover:bg-slate-700 hover:text-white">Today</button>
                            <button onclick="setMetric('dl', 'week', 'This Week')" class="block w-full text-left px-4 py-2 hover:bg-slate-700 hover:text-white">This Week</button>
                            <button onclick="setMetric('dl', 'month', 'This Month')" class="block w-full text-left px-4 py-2 hover:bg-slate-700 hover:text-white">This Month</button>
                            <div class="h-px bg-slate-700 my-1"></div>
                            <button onclick="setMetric('dl', 'all', 'All Time')" class="block w-full text-left px-4 py-2 hover:bg-slate-700 hover:text-emerald-400">All Time</button>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-baseline gap-2">
                    <span class="text-4xl font-black text-white fade-num" id="val-dl">--</span>
                    <span class="text-sm text-emerald-500 font-bold uppercase tracking-wider">Downloads</span>
                </div>
                <!-- Dynamic Label -->
                <div class="text-xs text-slate-500 mt-2 font-mono uppercase bg-slate-950/50 inline-block px-2 py-1 rounded border border-slate-800" id="label-dl">All Time</div>
            </div>

            <!-- CARD 3: VISITS (Dynamic) -->
            <div class="bg-slate-900 border border-white/5 p-6 rounded-xl shadow-lg relative group" id="card-viz">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-2 bg-purple-500/10 text-purple-400 rounded-lg"><span class="material-symbols-rounded">visibility</span></div>
                    
                    <!-- Dropdown Trigger -->
                    <div class="relative">
                        <button onclick="toggleDropdown('menu-viz')" class="text-slate-500 hover:text-white p-1 rounded hover:bg-slate-800 transition-colors">
                            <span class="material-symbols-rounded">more_vert</span>
                        </button>
                        <!-- Dropdown Menu -->
                        <div id="menu-viz" class="hidden absolute right-0 mt-2 w-32 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-20 py-1 text-xs font-bold text-slate-400 uppercase tracking-wider origin-top-right">
                            <button onclick="setMetric('viz', 'day', 'Today')" class="block w-full text-left px-4 py-2 hover:bg-slate-700 hover:text-white">Today</button>
                            <button onclick="setMetric('viz', 'week', 'This Week')" class="block w-full text-left px-4 py-2 hover:bg-slate-700 hover:text-white">This Week</button>
                            <button onclick="setMetric('viz', 'month', 'This Month')" class="block w-full text-left px-4 py-2 hover:bg-slate-700 hover:text-white">This Month</button>
                            <div class="h-px bg-slate-700 my-1"></div>
                            <button onclick="setMetric('viz', 'all', 'All Time')" class="block w-full text-left px-4 py-2 hover:bg-slate-700 hover:text-purple-400">All Time</button>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-baseline gap-2">
                    <span class="text-4xl font-black text-white fade-num" id="val-viz">--</span>
                    <span class="text-sm text-purple-500 font-bold uppercase tracking-wider">Visits</span>
                </div>
                <div class="text-xs text-slate-500 mt-2 font-mono uppercase bg-slate-950/50 inline-block px-2 py-1 rounded border border-slate-800" id="label-viz">All Time</div>
            </div>

        </div>

        <!-- 2. TABLE ACTIONS -->
 // 2. FETCH TABLE DATA (Admin Route)
    try {
        // ‚úÖ FIX: Use '/admin/animes' and pass Authorization header
        const res = await fetch(`${API_URL}/admin/animes?limit=200`, {
            headers: { 'Authorization': `Bearer ${ADMIN_KEY}` }
        });
        
        if (!res.ok) throw new Error("Table fetch failed");
        
        const data = await res.json();
        cache = data; // Store for search
        renderTable(data);
    } catch(e) { 
        console.error("Table error:", e); 
        document.getElementById('admin-table-body').innerHTML = `<tr><td colspan="5" class="text-center py-10 text-red-500">Error loading data. Check API connection.</td></tr>`;
    }
        <!-- 3. TABLE -->
        <div class="bg-slate-900 border border-white/5 rounded-xl overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left text-slate-400">
                    <thead class="bg-slate-950 text-xs uppercase font-bold text-slate-500 border-b border-white/5">
                        <tr>
                            <th class="px-6 py-4 w-16">ID</th>
                            <th class="px-6 py-4">Series</th>
                            <th class="px-6 py-4">Totals</th>
                            <th class="px-6 py-4">Status</th>
                            <th class="px-6 py-4 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5" id="admin-table-body">
                        <tr><td colspan="5" class="text-center py-10">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

<script>
        // ‚ö†Ô∏è PRODUCTION URL (Ensure this is correct for your deployment)
        const API_URL = 'https://aniclip-backend.onrender.com/api'; 
        
        const ADMIN_KEY = localStorage.getItem('aniclip_admin_key');
        
        // Redirect if not logged in
        if(!ADMIN_KEY) window.location.href = 'auth.html';

        // State Management
        let tableCache = [];
        let statsData = {}; 

        // --- 1. INITIAL LOAD ---
        window.onload = async () => {
            await Promise.all([loadStats(), loadTableData()]);
        };

        // --- 2. DATA FETCHERS ---

        async function loadStats() {
            try {
                // Fetches "Hybrid" stats (Live Logs + Total Counters)
                const res = await fetch(`${API_URL}/admin/stats`, { 
                    headers: { 'Authorization': `Bearer ${ADMIN_KEY}` }
                });
                
                if(res.ok) {
                    statsData = await res.json();
                    
                    // Set "Library Size" immediately (It's static)
                    document.getElementById('stat-series').innerText = statsData.total_series || 0;
                    
                    // Set Defaults for dynamic cards (All Time)
                    setMetric('dl', 'all', 'All Time');
                    setMetric('viz', 'all', 'All Time');
                }
            } catch(e) { console.error("Stats error:", e); }
        }

        async function loadTableData() {
            const tbody = document.getElementById('admin-table-body');
            try {
                // üõ†Ô∏è FIX: Now fetching from Admin API (No filtering, sorts by Newest)
                const res = await fetch(`${API_URL}/admin/animes?limit=500`, { 
                    headers: { 'Authorization': `Bearer ${ADMIN_KEY}` }
                });
                
                if(!res.ok) throw new Error("Failed to fetch list");

                const data = await res.json();
                tableCache = data; // Cache for search filtering
                renderTable(data);
                
            } catch(e) { 
                console.error(e); 
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-red-400">Connection Error. Check Console.</td></tr>`;
            }
        }

        // --- 3. RENDER TABLE ---
        function renderTable(data) {
            const tbody = document.getElementById('admin-table-body');
            tbody.innerHTML = '';
            
            if(data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-slate-500 italic">No series found.</td></tr>`;
                return;
            }

            data.forEach(anime => {
                const editUrl = `edit.html?name=${encodeURIComponent(anime.name)}`;
                
                // Badges
                const featuredBadge = anime.is_featured 
                    ? `<span class="inline-flex items-center gap-1 bg-emerald-500/10 text-emerald-400 text-[9px] font-bold px-2 py-1 rounded border border-emerald-500/20">FEATURED</span>` 
                    : `<span class="text-slate-600 text-[10px] font-bold uppercase tracking-wider opacity-50">Standard</span>`;

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-800/30 transition-colors border-b border-slate-800/50 last:border-0 group">
                        
                        <!-- ID -->
                        <td class="px-6 py-4 text-xs font-mono opacity-40">#${anime.id}</td>
                        
                        <!-- Title & Poster -->
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded bg-slate-800 border border-slate-700 overflow-hidden flex-shrink-0">
                                    <img src="${anime.poster_url}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" onerror="this.src='https://via.placeholder.com/50'">
                                </div>
                                <div>
                                    <div class="font-bold text-slate-200 text-sm group-hover:text-blue-400 transition-colors">${anime.title || anime.name}</div>
                                    <div class="text-[10px] text-slate-500 font-mono truncate max-w-[150px]">${anime.name}</div>
                                </div>
                            </div>
                        </td>
                        
                        <!-- Counts -->
                        <td class="px-6 py-4 text-xs">
                            <div class="flex gap-4">
                                <div title="Downloads"><span class="text-slate-500">DL:</span> <span class="text-emerald-400 font-bold">${anime.download_count}</span></div>
                                <div title="Visits"><span class="text-slate-500">Vis:</span> <span class="text-purple-400 font-bold">${anime.visit_count}</span></div>
                            </div>
                        </td>
                        
                        <!-- Status -->
                        <td class="px-6 py-4">${featuredBadge}</td>
                        
                        <!-- Actions -->
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-2 opacity-50 group-hover:opacity-100 transition-opacity">
                                <a href="${editUrl}" class="w-8 h-8 flex items-center justify-center bg-slate-800 hover:bg-blue-600 text-slate-300 hover:text-white rounded transition-colors border border-slate-700 hover:border-blue-500"><span class="material-symbols-rounded text-sm">edit</span></a>
                                <button onclick="deleteAnime(${anime.id})" class="w-8 h-8 flex items-center justify-center bg-slate-800 hover:bg-red-600 text-slate-300 hover:text-white rounded transition-colors border border-slate-700 hover:border-red-500"><span class="material-symbols-rounded text-sm">delete</span></button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        // --- 4. ACTIONS ---

        function handleAdminSearch() {
            const q = document.getElementById('admin-search').value.toLowerCase();
            const filtered = tableCache.filter(a => 
                (a.title || '').toLowerCase().includes(q) || a.name.includes(q)
            );
            renderTable(filtered);
        }

        async function deleteAnime(id) {
            if(!confirm("‚ö†Ô∏è WARNING: Permanently delete this series and all clips?")) return;
            
            try {
                await fetch(`${API_URL}/admin/animes/${id}`, { 
                    method: 'DELETE', 
                    headers: { 'Authorization': `Bearer ${ADMIN_KEY}` } 
                });
                // Refresh Data without reload
                loadTableData(); 
                loadStats(); 
            } catch(e) { alert("Delete failed. Check connection."); }
        }

        function logout() { 
            localStorage.removeItem('aniclip_admin_key'); 
            window.location.href='auth.html'; 
        }

        // --- 5. UI INTERACTIONS (Dropdowns & Metrics) ---

        window.toggleDropdown = function(id) {
            const menu = document.getElementById(id);
            // Close all others first
            document.querySelectorAll('[id^="menu-"]').forEach(el => {
                if(el.id !== id) el.classList.add('hidden');
            });
            menu.classList.toggle('hidden');
        };

        window.setMetric = function(type, period, label) {
            // type: 'dl' | 'viz'
            // period: 'day' | 'week' | 'month' | 'all'
            
            // Key mapping to match the SQL column aliases
            const dataKeyMap = {
                'dl_day': 'dl_today', 'dl_week': 'dl_week', 'dl_month': 'dl_month', 'dl_all': 'total_downloads',
                'viz_day': 'visits_today', 'viz_week': 'visits_week', 'viz_month': 'visits_month', 'viz_all': 'total_visits'
            };

            const targetKey = dataKeyMap[`${type}_${period}`];
            const valueElement = document.getElementById(`val-${type}`);
            const labelElement = document.getElementById(`label-${type}`);
            const menuElement = document.getElementById(`menu-${type}`);

            // Update Label
            labelElement.innerText = label;
            menuElement.classList.add('hidden'); // Close menu

            // Animate Number Change
            valueElement.classList.add('opacity-0');
            setTimeout(() => {
                valueElement.innerText = statsData[targetKey] || 0;
                valueElement.classList.remove('opacity-0');
            }, 150);
        };

        // Global Click to Close Dropdowns
        document.addEventListener('click', function(e) {
            const isButton = e.target.closest('button[onclick^="toggleDropdown"]');
            const isMenu = e.target.closest('[id^="menu-"]');
            
            if (!isButton && !isMenu) {
                document.querySelectorAll('[id^="menu-"]').forEach(el => el.classList.add('hidden'));
            }
        });

    </script>
</body>
</html>