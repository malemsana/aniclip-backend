<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | AnimeClips</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <script>
        tailwind.config = {
            theme: { extend: { colors: { gray: { 900: '#0f172a', 950: '#020617' } } } }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; }
        .material-symbols-rounded { font-size: 20px; }
        /* Smooth fade for number changes */
        .fade-num { transition: opacity 0.2s ease-in-out; }
        .fade-out { opacity: 0; }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-gradient-to-b from-gray-950 to-slate-950">

    <!-- ==== NAVBAR ==== -->
    <nav class="sticky top-0 z-50 border-b border-white/5 bg-slate-950/80 backdrop-blur-md">
        <div class="container mx-auto px-6 h-16 flex justify-between items-center">
            <div class="flex items-center gap-2 font-bold text-lg">
                <div class="w-7 h-7 bg-blue-600 rounded flex items-center justify-center text-white">
                    <span class="material-symbols-rounded" style="font-size: 18px;">admin_panel_settings</span>
                </div>
                <span class="text-slate-200">AnimeClips <span class="text-slate-600 font-normal text-sm ml-1">| Panel</span></span>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="logout()" class="bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500 hover:text-white px-3 py-1.5 rounded text-xs font-bold uppercase tracking-wide transition-all">
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- ==== MAIN CONTENT ==== -->
    <main class="container mx-auto px-6 py-8 flex-grow">
        
        <!-- 1. ANALYTICS CARDS -->
        <h2 class="text-white font-bold text-sm uppercase tracking-wider mb-4 flex items-center gap-2">
            <span class="material-symbols-rounded text-blue-500">monitoring</span> Analytics
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            
            <!-- CARD 1: LIBRARY SIZE (Static) -->
            <div class="bg-slate-900 border border-white/5 p-6 rounded-xl shadow-lg relative">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-2 bg-blue-500/10 text-blue-400 rounded-lg"><span class="material-symbols-rounded">video_library</span></div>
                </div>
                <div class="flex items-baseline gap-2">
                    <span class="text-4xl font-black text-white" id="stat-series">--</span>
                    <span class="text-sm text-slate-500 font-bold uppercase tracking-wider">Series</span>
                </div>
                <div class="text-xs text-slate-600 mt-2">Total active items in library</div>
            </div>

            <!-- CARD 2: DOWNLOADS (Dynamic) -->
            <div class="bg-slate-900 border border-white/5 p-6 rounded-xl shadow-lg relative group" id="card-dl">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-2 bg-emerald-500/10 text-emerald-400 rounded-lg"><span class="material-symbols-rounded">download</span></div>
                    
                    <!-- Dropdown Trigger -->
                    <div class="relative">
                        <button onclick="toggleDropdown('menu-dl')" class="text-slate-500 hover:text-white p-1 rounded hover:bg-slate-800 transition-colors">
                            <span class="material-symbols-rounded">more_vert</span>
                        </button>
                        <!-- Dropdown Menu -->
                        <div id="menu-dl" class="hidden absolute right-0 mt-2 w-32 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-20 py-1 text-xs font-bold text-slate-400 uppercase tracking-wider origin-top-right">
                            <button onclick="setMetric('dl', 'day', 'Today')" class="block w-full text-left px-4 py-2 hover:bg-slate-700 hover:text-white">Today</button>
                            <button onclick="setMetric('dl', 'week', 'This Week')" class="block w-full text-left px-4 py-2 hover:bg-slate-700 hover:text-white">This Week</button>
                            <button onclick="setMetric('dl', 'month', 'This Month')" class="block w-full text-left px-4 py-2 hover:bg-slate-700 hover:text-white">This Month</button>
                            <div class="h-px bg-slate-700 my-1"></div>
                            <button onclick="setMetric('dl', 'all', 'All Time')" class="block w-full text-left px-4 py-2 hover:bg-slate-700 hover:text-emerald-400">All Time</button>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-baseline gap-2">
                    <span class="text-4xl font-black text-white fade-num" id="val-dl">--</span>
                    <span class="text-sm text-emerald-500 font-bold uppercase tracking-wider">Downloads</span>
                </div>
                <!-- Dynamic Label -->
                <div class="text-xs text-slate-500 mt-2 font-mono uppercase bg-slate-950/50 inline-block px-2 py-1 rounded border border-slate-800" id="label-dl">All Time</div>
            </div>

            <!-- CARD 3: VISITS (Dynamic) -->
            <div class="bg-slate-900 border border-white/5 p-6 rounded-xl shadow-lg relative group" id="card-viz">
                <div class="flex justify-between items-start mb-4">
                    <div class="p-2 bg-purple-500/10 text-purple-400 rounded-lg"><span class="material-symbols-rounded">visibility</span></div>
                    
                    <!-- Dropdown Trigger -->
                    <div class="relative">
                        <button onclick="toggleDropdown('menu-viz')" class="text-slate-500 hover:text-white p-1 rounded hover:bg-slate-800 transition-colors">
                            <span class="material-symbols-rounded">more_vert</span>
                        </button>
                        <!-- Dropdown Menu -->
                        <div id="menu-viz" class="hidden absolute right-0 mt-2 w-32 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-20 py-1 text-xs font-bold text-slate-400 uppercase tracking-wider origin-top-right">
                            <button onclick="setMetric('viz', 'day', 'Today')" class="block w-full text-left px-4 py-2 hover:bg-slate-700 hover:text-white">Today</button>
                            <button onclick="setMetric('viz', 'week', 'This Week')" class="block w-full text-left px-4 py-2 hover:bg-slate-700 hover:text-white">This Week</button>
                            <button onclick="setMetric('viz', 'month', 'This Month')" class="block w-full text-left px-4 py-2 hover:bg-slate-700 hover:text-white">This Month</button>
                            <div class="h-px bg-slate-700 my-1"></div>
                            <button onclick="setMetric('viz', 'all', 'All Time')" class="block w-full text-left px-4 py-2 hover:bg-slate-700 hover:text-purple-400">All Time</button>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-baseline gap-2">
                    <span class="text-4xl font-black text-white fade-num" id="val-viz">--</span>
                    <span class="text-sm text-purple-500 font-bold uppercase tracking-wider">Visits</span>
                </div>
                <div class="text-xs text-slate-500 mt-2 font-mono uppercase bg-slate-950/50 inline-block px-2 py-1 rounded border border-slate-800" id="label-viz">All Time</div>
            </div>

        </div>

        <!-- 2. TABLE ACTIONS -->
        <div class="flex flex-col sm:flex-row justify-between items-end sm:items-center mb-6 gap-4">
            <div>
                <h1 class="text-xl font-bold text-white">Library Content</h1>
                <p class="text-slate-500 text-xs">Manage database entries.</p>
            </div>
            <div class="flex gap-3 w-full sm:w-auto">
                <div class="relative flex-grow sm:flex-grow-0">
                    <span class="material-symbols-rounded absolute left-3 top-2.5 text-slate-500">search</span>
                    <input type="text" id="admin-search" onkeyup="handleAdminSearch()" placeholder="Search..." class="w-full sm:w-64 bg-slate-900 border border-slate-700 text-slate-200 pl-10 pr-4 py-2 rounded-lg focus:outline-none focus:border-blue-500 transition-colors text-sm">
                </div>
                <a href="edit.html" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-colors shadow-lg shadow-blue-600/20 whitespace-nowrap">
                    <span class="material-symbols-rounded text-lg">add</span> Add
                </a>
            </div>
        </div>

        <!-- 3. TABLE -->
        <div class="bg-slate-900 border border-white/5 rounded-xl overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left text-slate-400">
                    <thead class="bg-slate-950 text-xs uppercase font-bold text-slate-500 border-b border-white/5">
                        <tr>
                            <th class="px-6 py-4 w-16">ID</th>
                            <th class="px-6 py-4">Series</th>
                            <th class="px-6 py-4">Totals</th>
                            <th class="px-6 py-4">Status</th>
                            <th class="px-6 py-4 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5" id="admin-table-body">
                        <tr><td colspan="5" class="text-center py-10">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const API_URL = 'https://aniclip-backend.onrender.com'; 
        const ADMIN_KEY = localStorage.getItem('aniclip_admin_key');
        if(!ADMIN_KEY) window.location.href = 'auth.html';

        let cache = [];
        let statsData = {}; // Holds the raw API response

        window.onload = async () => {
            // 1. Fetch & Render Stats
            try {
                const statRes = await fetch(`${API_URL}/admin/stats`, { headers: { 'Authorization': `Bearer ${ADMIN_KEY}` }});
                if(statRes.ok) {
                    statsData = await statRes.json();
                    document.getElementById('stat-series').innerText = statsData.total_series || 0;
                    
                    // Initial State (All Time)
                    setMetric('dl', 'all', 'All Time');
                    setMetric('viz', 'all', 'All Time');
                }
            } catch(e) { console.error("Stats error:", e); }

            // 2. Fetch & Render Table
            try {
                const res = await fetch(`${API_URL}/animes?limit=200`);
                cache = await res.json();
                renderTable(cache);
            } catch(e) { console.error("Table error:", e); }
        };

        // --- STATS DROPDOWN LOGIC ---
        
        function toggleDropdown(id) {
            const menu = document.getElementById(id);
            // Close others
            ['menu-dl', 'menu-viz'].forEach(mId => {
                if(mId !== id) document.getElementById(mId).classList.add('hidden');
            });
            menu.classList.toggle('hidden');
        }

        function setMetric(type, period, label) {
            // type = 'dl' or 'viz'
            // period = 'day', 'week', 'month', 'all'
            const keyMap = {
                'dl_day': 'dl_today', 'dl_week': 'dl_week', 'dl_month': 'dl_month', 'dl_all': 'total_downloads',
                'viz_day': 'visits_today', 'viz_week': 'visits_week', 'viz_month': 'viz_month', 'viz_all': 'total_visits'
            };

            const dataKey = keyMap[`${type}_${period}`];
            const valEl = document.getElementById(`val-${type}`);
            
            // 1. Update Label
            document.getElementById(`label-${type}`).innerText = label;
            document.getElementById(`menu-${type}`).classList.add('hidden');

            // 2. Animate Number Swap
            valEl.classList.add('opacity-0', 'translate-y-2');
            
            setTimeout(() => {
                valEl.innerText = statsData[dataKey] || 0;
                valEl.classList.remove('opacity-0', 'translate-y-2');
            }, 150);
        }

        // Close dropdowns on click outside
        document.addEventListener('click', (e) => {
            if(!e.target.closest('.relative')) {
                document.getElementById('menu-dl').classList.add('hidden');
                document.getElementById('menu-viz').classList.add('hidden');
            }
        });

        // --- TABLE LOGIC (Same as before) ---
        function renderTable(data) {
            const tbody = document.getElementById('admin-table-body');
            tbody.innerHTML = '';
            if(data.length === 0) return tbody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-slate-500">Empty.</td></tr>`;

            data.forEach(anime => {
                const status = anime.is_featured 
                    ? `<span class="bg-emerald-500/10 text-emerald-400 text-[10px] font-bold px-2 py-1 rounded border border-emerald-500/20">FEATURED</span>`
                    : `<span class="text-slate-600 text-[10px]">STD</span>`;

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-800/30 border-b border-white/5 last:border-0">
                        <td class="px-6 py-4 text-xs opacity-50 font-mono">#${anime.id}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <img src="${anime.poster_url}" class="w-8 h-8 rounded object-cover bg-slate-800">
                                <span class="text-sm font-bold text-slate-200 truncate max-w-[150px]">${anime.title}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-xs text-slate-400">
                            <span class="text-emerald-400 font-bold">${anime.download_count}</span> DL / <span class="text-blue-400 font-bold">${anime.visit_count}</span> VIS
                        </td>
                        <td class="px-6 py-4">${status}</td>
                        <td class="px-6 py-4 text-right">
                            <a href="edit.html?name=${encodeURIComponent(anime.name)}" class="text-blue-400 hover:text-white mr-3 font-bold text-xs">EDIT</a>
                            <button onclick="deleteAnime(${anime.id})" class="text-red-500 hover:text-white font-bold text-xs">DEL</button>
                        </td>
                    </tr>`;
            });
        }

        async function deleteAnime(id) {
            if(confirm("Delete Series?")) {
                await fetch(`${API_URL}/admin/animes/${id}`, { method: 'DELETE', headers: {'Authorization': `Bearer ${ADMIN_KEY}`} });
                window.location.reload();
            }
        }

        function handleAdminSearch() {
            const q = document.getElementById('admin-search').value.toLowerCase();
            renderTable(cache.filter(a => (a.title||'').toLowerCase().includes(q)));
        }

        function logout() { localStorage.removeItem('aniclip_admin_key'); window.location.href='auth.html'; }
    </script>
</body>
</html>